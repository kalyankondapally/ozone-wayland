From 7345aefe1698282fd841532a3ee4f9eaf5797e72 Mon Sep 17 00:00:00 2001
From: Kondapally Kalyan <kalyan.kondapally@intel.com>
Date: Sun, 10 Nov 2013 22:58:16 +0200
Subject: [PATCH 08/15] Event rewriter changes.

---
 chrome/browser/ui/ash/event_rewriter.cc |   36 ++++++++++++++++++++-----------
 chrome/browser/ui/ash/event_rewriter.h  |    3 ++-
 2 files changed, 25 insertions(+), 14 deletions(-)

diff --git a/chrome/browser/ui/ash/event_rewriter.cc b/chrome/browser/ui/ash/event_rewriter.cc
index d323f74..606503c 100644
--- a/chrome/browser/ui/ash/event_rewriter.cc
+++ b/chrome/browser/ui/ash/event_rewriter.cc
@@ -17,10 +17,12 @@
 #include "ui/events/keycodes/keyboard_code_conversion.h"
 
 #if defined(OS_CHROMEOS)
+#if defined(USE_X11)
 #include <X11/extensions/XInput2.h>
 #include <X11/keysym.h>
 #include <X11/XF86keysym.h>
 #include <X11/Xlib.h>
+#endif
 
 // Get rid of a macro from Xlib.h that conflicts with OwnershipService class.
 #undef Status
@@ -31,13 +33,17 @@
 #include "chrome/browser/chromeos/keyboard_driven_event_rewriter.h"
 #include "chrome/browser/chromeos/login/login_display_host_impl.h"
 #include "chrome/browser/chromeos/login/user_manager.h"
+#if defined(USE_X11)
 #include "chrome/browser/chromeos/xinput_hierarchy_changed_event_listener.h"
+#endif
 #include "chrome/common/pref_names.h"
 #include "chromeos/chromeos_switches.h"
 #include "chromeos/ime/input_method_manager.h"
+#if defined(USE_X11)
 #include "chromeos/ime/xkeyboard.h"
 #include "ui/base/x/x11_util.h"
 #include "ui/events/keycodes/keyboard_code_conversion_x.h"
+#endif
 #include "ui/views/corewm/window_util.h"
 #endif
 
@@ -45,7 +51,7 @@ namespace {
 
 const int kBadDeviceId = -1;
 
-#if defined(OS_CHROMEOS)
+#if defined(OS_CHROMEOS) && defined(USE_X11)
 const char kNeo2LayoutId[] = "xkb:de:neo:ger";
 const char kCaMultixLayoutId[] = "xkb:ca:multix:fra";
 
@@ -142,7 +148,7 @@ bool IsMod3UsedByCurrentInputMethod() {
 
 EventRewriter::EventRewriter()
     : last_device_id_(kBadDeviceId),
-#if defined(OS_CHROMEOS)
+#if defined(OS_CHROMEOS) && defined(USE_X11)
       xkeyboard_for_testing_(NULL),
       keyboard_driven_event_rewriter_(
           new chromeos::KeyboardDrivenEventRewriter),
@@ -153,7 +159,7 @@ EventRewriter::EventRewriter()
     ash::Shell::GetPrimaryRootWindow()->GetDispatcher()->
         AddRootWindowObserver(this);
   }
-#if defined(OS_CHROMEOS)
+#if defined(OS_CHROMEOS) && defined(USE_X11)
   if (base::SysInfo::IsRunningOnChromeOS()) {
     chromeos::XInputHierarchyChangedEventListener::GetInstance()
         ->AddObserver(this);
@@ -167,7 +173,7 @@ EventRewriter::~EventRewriter() {
     ash::Shell::GetPrimaryRootWindow()->GetDispatcher()->
         RemoveRootWindowObserver(this);
   }
-#if defined(OS_CHROMEOS)
+#if defined(OS_CHROMEOS) && defined(USE_X11)
   if (base::SysInfo::IsRunningOnChromeOS()) {
     chromeos::XInputHierarchyChangedEventListener::GetInstance()
         ->RemoveObserver(this);
@@ -222,13 +228,14 @@ ash::EventRewriterDelegate::Action EventRewriter::RewriteOrFilterLocatedEvent(
 }
 
 void EventRewriter::OnKeyboardMappingChanged(const aura::RootWindow* root) {
-#if defined(OS_CHROMEOS)
+#if defined(OS_CHROMEOS) && defined(USE_X11)
   RefreshKeycodes();
 #endif
 }
 
 #if defined(OS_CHROMEOS)
 void EventRewriter::DeviceAdded(int device_id) {
+#if defined(USE_X11)
   DCHECK_NE(XIAllDevices, device_id);
   DCHECK_NE(XIAllMasterDevices, device_id);
   if (device_id == XIAllDevices || device_id == XIAllMasterDevices) {
@@ -256,6 +263,7 @@ void EventRewriter::DeviceAdded(int device_id) {
   }
 
   XIFreeDeviceInfo(device_info);
+#endif
 }
 
 void EventRewriter::DeviceRemoved(int device_id) {
@@ -278,6 +286,7 @@ void EventRewriter::RefreshKeycodes() {
   keysym_to_keycode_map_.clear();
 }
 
+#if defined(USE_X11)
 KeyCode EventRewriter::NativeKeySymToNativeKeycode(KeySym keysym) {
   if (keysym_to_keycode_map_.count(keysym))
     return keysym_to_keycode_map_[keysym];
@@ -364,6 +373,7 @@ bool EventRewriter::RewriteWithKeyboardRemappingsByKeyCode(
   return false;
 }
 #endif  // defined(OS_CHROMEOS)
+#endif
 
 const PrefService* EventRewriter::GetPrefService() const {
   if (pref_service_for_testing_)
@@ -373,7 +383,7 @@ const PrefService* EventRewriter::GetPrefService() const {
 }
 
 void EventRewriter::Rewrite(ui::KeyEvent* event) {
-#if defined(OS_CHROMEOS)
+#if defined(OS_CHROMEOS) && defined(USE_X11)
   // Do not rewrite an event sent by ui_controls::SendKeyPress(). See
   // crbug.com/136465.
   if (event->native_event()->xkey.send_event)
@@ -413,7 +423,7 @@ void EventRewriter::GetRemappedModifierMasks(
     unsigned int original_native_modifiers,
     int* remapped_flags,
     unsigned int* remapped_native_modifiers) const {
-#if defined(OS_CHROMEOS)
+#if defined(OS_CHROMEOS) && defined(USE_X11)
   // TODO(glotov): remove the following condition when we do not restart chrome
   // when user logs in as guest. See Rewrite() for details.
   if (chromeos::UserManager::Get()->IsLoggedInAsGuest() &&
@@ -474,7 +484,7 @@ void EventRewriter::GetRemappedModifierMasks(
 }
 
 bool EventRewriter::RewriteModifiers(ui::KeyEvent* event) {
-#if defined(OS_CHROMEOS)
+#if defined(OS_CHROMEOS) && defined(USE_X11)
   // Do nothing if we have just logged in as guest but have not restarted chrome
   // process yet (so we are still on the login screen). In this situations we
   // have no user profile so can not do anything useful.
@@ -589,7 +599,7 @@ bool EventRewriter::RewriteModifiers(ui::KeyEvent* event) {
 
 bool EventRewriter::RewriteNumPadKeys(ui::KeyEvent* event) {
   bool rewritten = false;
-#if defined(OS_CHROMEOS)
+#if defined(OS_CHROMEOS) && defined(USE_X11)
   XEvent* xev = event->native_event();
   XKeyEvent* xkey = &(xev->xkey);
 
@@ -681,7 +691,7 @@ bool EventRewriter::RewriteNumPadKeys(ui::KeyEvent* event) {
 }
 
 bool EventRewriter::RewriteExtendedKeys(ui::KeyEvent* event) {
-#if defined(OS_CHROMEOS)
+#if defined(OS_CHROMEOS) && defined(USE_X11)
   XEvent* xev = event->native_event();
   XKeyEvent* xkey = &(xev->xkey);
   const KeySym keysym = XLookupKeysym(xkey, 0);
@@ -851,7 +861,7 @@ bool EventRewriter::RewriteExtendedKeys(ui::KeyEvent* event) {
 }
 
 bool EventRewriter::RewriteFunctionKeys(ui::KeyEvent* event) {
-#if defined(OS_CHROMEOS)
+#if defined(OS_CHROMEOS) && defined(USE_X11)
   XEvent* xev = event->native_event();
   XKeyEvent* xkey = &(xev->xkey);
   const KeySym keysym = XLookupKeysym(xkey, 0);
@@ -983,7 +993,7 @@ bool EventRewriter::RewriteFunctionKeys(ui::KeyEvent* event) {
 }
 
 void EventRewriter::RewriteLocatedEvent(ui::LocatedEvent* event) {
-#if defined(OS_CHROMEOS)
+#if defined(OS_CHROMEOS) && defined(USE_X11)
   if (event->flags() & ui::EF_IS_SYNTHESIZED)
     return;
 
@@ -1029,7 +1039,7 @@ void EventRewriter::OverwriteEvent(ui::KeyEvent* event,
                                    unsigned int new_native_state,
                                    ui::KeyboardCode new_keycode,
                                    int new_flags) {
-#if defined(OS_CHROMEOS)
+#if defined(OS_CHROMEOS) && defined(USE_X11)
   XEvent* xev = event->native_event();
   XKeyEvent* xkey = &(xev->xkey);
   xkey->keycode = new_native_keycode;
diff --git a/chrome/browser/ui/ash/event_rewriter.h b/chrome/browser/ui/ash/event_rewriter.h
index 68ef918..db54085 100644
--- a/chrome/browser/ui/ash/event_rewriter.h
+++ b/chrome/browser/ui/ash/event_rewriter.h
@@ -102,6 +102,7 @@ class EventRewriter : public ash::EventRewriterDelegate,
 
   // Updates |*_xkeycode_| in response to a keyboard map change.
   void RefreshKeycodes();
+#if defined(USE_X11)
   // Converts an X key symbol like XK_Control_L to a key code.
   unsigned char NativeKeySymToNativeKeycode(KeySym keysym);
 
@@ -151,7 +152,7 @@ class EventRewriter : public ash::EventRewriterDelegate,
       ui::KeyboardCode* remapped_keycode,
       unsigned int* remapped_mods);
 #endif
-
+#endif
   // Returns the PrefService that should be used.
   const PrefService* GetPrefService() const;
 
-- 
1.7.9.5

